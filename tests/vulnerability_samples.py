"""
Сэмплы уязвимого кода для тестирования статического анализатора.
Файл содержит примеры для всех поддерживаемых классов CWE согласно README.md и vulnerabilities.py.
"""

import os
import subprocess
import pickle
import yaml
import hashlib
import sqlite3
import xml.etree.ElementTree as ET
from lxml import etree


def code_injection_demo():
    """CWE-94: Code Injection (eval, exec, compile)."""
    user_code = input("Введите код: ")
    eval(user_code)  # VULN
    exec(user_code)  # VULN
    compile(user_code, '<string>', 'exec')  # VULN


def command_injection_demo():
    """CWE-78: Command Injection (os.system, subprocess)."""
    user_cmd = input("Введите команду: ")
    os.system(user_cmd)  # VULN
    subprocess.run(user_cmd, shell=True)  # VULN
    subprocess.call(user_cmd, shell=True)  # VULN
    subprocess.Popen(user_cmd, shell=True)  # VULN


def deserialization_demo():
    """CWE-502: Deserialization (pickle, yaml)."""
    user_data = input("Введите данные: ")
    pickle.loads(user_data)  # VULN
    
    with open("data.pkl", "rb") as f:
        pickle.load(f)  # VULN
        
    yaml.load(user_data, Loader=yaml.Loader)  # VULN
    yaml.unsafe_load(user_data)  # VULN


def path_traversal_demo():
    """CWE-22: Path Traversal (open, os.path.join)."""
    user_path = input("Введите путь: ")
    open(user_path, 'r')  # VULN
    os.path.join("/tmp/", user_path)  # VULN


def weak_crypto_demo():
    """CWE-327: Weak Cryptography (MD5, SHA1)."""
    data = b"password"
    hashlib.md5(data)  # VULN
    hashlib.sha1(data)  # VULN


def hardcoded_credentials_demo():
    """CWE-798: Hardcoded Credentials."""
    password = "super_secret_password"  # VULN
    api_key = "sk-1234567890abcdef"  # VULN
    token = "ghp_1234567890abcdef"  # VULN
    secret = "my_secret_key"  # VULN


def debug_features_demo():
    """CWE-489: Debug Features (debug=True)."""
    def start_server(port, debug=False):
        print(f"Server started on {port}, debug={debug}")
    
    start_server(8080, debug=True)  # VULN


def sql_injection_demo():
    """CWE-89: SQL Injection (execute)."""
    conn = sqlite3.connect(":memory:")
    cursor = conn.cursor()
    user_id = input("ID: ")
    
    # Уязвимо: форматирование строк
    cursor.execute(f"SELECT * FROM users WHERE id = {user_id}")  # VULN
    cursor.execute("SELECT * FROM users WHERE id = %s" % user_id)  # VULN
    
    # Безопасно (для сравнения):
    cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))


def xxe_demo():
    """CWE-611: XML External Entities (XXE)."""
    user_xml = input("XML: ")
    ET.fromstring(user_xml)  # VULN
    etree.fromstring(user_xml)  # VULN


if __name__ == "__main__":
    code_injection_demo()
    command_injection_demo()
    deserialization_demo()
    path_traversal_demo()
    weak_crypto_demo()
    hardcoded_credentials_demo()
    debug_features_demo()
    sql_injection_demo()
    xxe_demo()
